#!/usr/bin/env node

var fs = require("fs");
var mkdirp = require("mkdirp");
var path = require("path");
var jsonFormat = require("json-format");
var grunt = require("grunt");

grunt.initConfig = initConfig;
var gruntFilePath = process.cwd() + "/Gruntfile";
var processGruntFile = require(gruntFilePath);

var jsonFormatConfig = {
  type: "space",
  size: 2
};

var excludeGruntTasks = [
  "pkg"
];

function fileStream(dest) {
  mkdirp.sync(path.dirname(dest));
  return fs.createWriteStream(dest);
}

function initConfig(config) {
  Object.keys(config)
    .filter(function(key) {
      return excludeGruntTasks.indexOf(key) === -1;
    })
    .forEach(function(key) {
      writeConfig(key, config[key]);
    })
};

function writeConfig(fileName, options) {
  var taskConfigPath = "./tasks/" + fileName + ".js";

  console.log("Writing:", "./tasks/" + fileName + ".js");

  var writableStream = fileStream("./tasks/" + fileName + ".js");
  writableStream.write("module.exports = " + jsonFormat(options, jsonFormatConfig) + ";");
}

try {
  processGruntFile(grunt);
}
catch(ex) {
  console.log(ex);
}
